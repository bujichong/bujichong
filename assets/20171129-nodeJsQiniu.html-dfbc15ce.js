import{_ as s,p as a,q as p,w as t,s as n,J as o}from"./framework-d4dfb5a8.js";const e={},c=n("blockquote",null,[n("p",null,"昨晚我把七牛的服务限制了一下，被网上刷流量的情况吓着了，看来博客除了域名，其他统统免费爽不是那么容易的。")],-1),l=o(`<p>说批量，肯定是已经有了对应的文件列表，这里我是有的，我用NodeJs处理图片的时候顺便生成了文件路径Json，格式大体如下：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cs_xihu_20171126/0.jpg&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pic&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;time&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2017-11-27 9:7:19&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;w&quot;</span><span class="token operator">:</span> <span class="token number">1125</span><span class="token punctuation">,</span>
      <span class="token property">&quot;h&quot;</span><span class="token operator">:</span> <span class="token number">1500</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cs_xihu_20171126/1.jpg&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pic&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;time&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2017-11-27 9:7:50&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;w&quot;</span><span class="token operator">:</span> <span class="token number">1125</span><span class="token punctuation">,</span>
      <span class="token property">&quot;h&quot;</span><span class="token operator">:</span> <span class="token number">1500</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cs_xihu_20171126/2.jpg&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pic&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;time&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2017-11-27 9:10:8&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;w&quot;</span><span class="token operator">:</span> <span class="token number">1125</span><span class="token punctuation">,</span>
      <span class="token property">&quot;h&quot;</span><span class="token operator">:</span> <span class="token number">1500</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结构就是如此，反正是n多个文件组成，上传对应到七牛的路径，需要用到的就是这个 <strong>name</strong> 。</p><p>然后就是上传需要用到的配置，这些账号信息什么的是必须的：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">let</span> opt <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment">//七牛账号信息——用于上传，详细参数及nodeAPI : https://developer.qiniu.com/kodo/sdk/1289/nodejs</span>
    <span class="token literal-property property">accessKey</span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token comment">//sk</span>
    <span class="token literal-property property">secretKey</span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token comment">//sk</span>
    <span class="token literal-property property">bucket</span> <span class="token operator">:</span>  <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span><span class="token comment">//文件容器</span>
    <span class="token literal-property property">zone</span> <span class="token operator">:</span> <span class="token string">&#39;Zone_z0&#39;</span><span class="token comment">//空间对应机房区域：华南</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行函数：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code> <span class="token keyword">function</span> <span class="token function">uploadQiniu</span><span class="token punctuation">(</span><span class="token parameter">opt <span class="token punctuation">,</span> jsonFile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//jsonFile对应上传的文件名</span>
   <span class="token keyword">let</span> o <span class="token operator">=</span> opt<span class="token punctuation">;</span>
   <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//获取七牛上传临时uploadToken</span>
     <span class="token keyword">let</span> mac <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>digest<span class="token punctuation">.</span>Mac</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>accessKey<span class="token punctuation">,</span> o<span class="token punctuation">.</span>secretKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
       <span class="token literal-property property">scope</span><span class="token operator">:</span> o<span class="token punctuation">.</span>bucket
     <span class="token punctuation">}</span><span class="token punctuation">;</span>
     <span class="token keyword">let</span> putPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>rs<span class="token punctuation">.</span>PutPolicy</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">let</span> uploadToken<span class="token operator">=</span>putPolicy<span class="token punctuation">.</span><span class="token function">uploadToken</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">resolve</span><span class="token punctuation">(</span>uploadToken<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回uploadToken</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


   promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">uploadToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//上传图片</span>
     <span class="token comment">// console.log(uploadToken);</span>
     <span class="token keyword">let</span> file<span class="token operator">=</span> jsonFile<span class="token punctuation">;</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;上传文件对应的json路径：&#39;</span><span class="token operator">+</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">let</span> filesData <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
     <span class="token keyword">try</span><span class="token punctuation">{</span>
       filesData <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span> file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;需要上传文件的json路径不正确~&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadToken<span class="token operator">&amp;&amp;</span>filesData<span class="token operator">&amp;&amp;</span>filesData<span class="token punctuation">.</span>data<span class="token operator">&amp;&amp;</span>filesData<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//检验是否满足需要上传的条件</span>
       <span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       config<span class="token punctuation">.</span>zone <span class="token operator">=</span> qiniu<span class="token punctuation">.</span>zone<span class="token punctuation">[</span>o<span class="token punctuation">.</span>zone<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 空间对应的机房</span>

       <span class="token keyword">let</span> formUploader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>form_up<span class="token punctuation">.</span>FormUploader</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">let</span> putExtra <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>form_up<span class="token punctuation">.</span>PutExtra</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">let</span> dataLen <span class="token operator">=</span> filesData<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

       <span class="token comment">// 循环文件上传</span>
       filesData<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">let</span> localFile <span class="token operator">=</span> opt<span class="token punctuation">.</span>fileOutPath <span class="token operator">+</span> item<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
         <span class="token keyword">let</span> key<span class="token operator">=</span> item<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
         formUploader<span class="token punctuation">.</span><span class="token function">putFile</span><span class="token punctuation">(</span>uploadToken<span class="token punctuation">,</span> key<span class="token punctuation">,</span> localFile<span class="token punctuation">,</span> putExtra<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">respErr<span class="token punctuation">,</span>respBody<span class="token punctuation">,</span> respInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>respErr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">throw</span> respErr<span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>respInfo<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>respBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
             console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>respInfo<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
             console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>respBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> dataLen<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;上传任务结束，共上传处理&#39;</span><span class="token operator">+</span>dataLen<span class="token operator">+</span><span class="token string">&#39;个文件~&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token punctuation">}</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ok，写的可能有点啰嗦，而且我是es5,se6随便写，但是大体就是这样。</p><p>更多细节可以参考官方文档： https://developer.qiniu.com/kodo/sdk/1289/nodejs 。</p>`,9);function u(i,k){return a(),p("div",null,[c,t(" more "),l])}const d=s(e,[["render",u],["__file","20171129-nodeJsQiniu.html.vue"]]);export{d as default};
